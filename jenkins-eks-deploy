pipeline {
    agent any

    environment {
        // Set correct AWS region and EKS cluster name
        AWS_DEFAULT_REGION = 'ap-south-1'
        CLUSTER_NAME = 'kube-eks-cluster'

        // Optional: specify kubeconfig path for Jenkins user
        KUBECONFIG = '/var/lib/jenkins/.kube/config'
    }

    stages {
        stage('Checkout Code') {
            steps {
                echo "Checking out source code..."
                checkout scm
            }
        }

        stage('Configure Kubeconfig') {
            steps {
                sh '''
                    echo "Configuring kubeconfig for EKS cluster: $CLUSTER_NAME in region $AWS_DEFAULT_REGION..."
                    aws eks --region $AWS_DEFAULT_REGION update-kubeconfig --name $CLUSTER_NAME --alias jenkins-eks

                    echo "Verifying cluster connectivity..."
                    kubectl cluster-info
                    kubectl get nodes -o wide
                '''
            }
        }

        stage('Deploy to EKS') {
            steps {
                sh '''
                    echo "Starting deployment to EKS..."
                    kubectl apply -f nginx/
                    kubectl apply -f httpd/

                    echo "Verifying deployed resources..."
                    kubectl get all -n default
                '''
            }
        }
    }

    post {
        success {
            echo "✅ Deployment to EKS succeeded!"
        }
        failure {
            echo "❌ Deployment failed — check logs above for details."
        }
    }
}

